# RTF è®­ç»ƒ-æ¨ç†ä¸€è‡´æ€§é—®é¢˜ä¸å®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜å‘ç°è¿‡ç¨‹

### 1. å¯¹æ¯”ç¤ºä¾‹ä»£ç 

ç”¨æˆ·æä¾›çš„ç¤ºä¾‹ä»£ç ï¼ˆ`examples/rtf.py`ï¼‰ï¼š
```python
# ä» x_0 (å™ªå£°) åˆ° x_1 (æ•°æ®)
x_t = t * x_1 + (1 - t) * x_0
v_target = x_1 - x_0
```

æˆ‘ä»¬çš„å®ç°ï¼š
```python
# ä» z1 (èµ·ç‚¹) åˆ° z2 (ç»ˆç‚¹)
z_t = (1 - t) * z1 + t * z2
v_target = z2 - z1
```

**ç»“è®ºï¼šä¸¤è€…æ•°å­¦ä¸Šç­‰ä»·ï¼Œåªæ˜¯ç¬¦å·çº¦å®šä¸åŒã€‚æˆ‘ä»¬çš„å®ç°æœ¬èº«æ˜¯æ­£ç¡®çš„ã€‚**

### 2. å‘ç°å…³é”®é—®é¢˜ï¼šè®­ç»ƒ-æ¨ç†ä¸ä¸€è‡´

#### é—®é¢˜åˆ†æ

åœ¨ scimilarity encoder ä¸­ï¼Œè¾“å‡ºè¢« L2 å½’ä¸€åŒ–åˆ°å•ä½çƒé¢ï¼š

```python
def forward(self, x) -> torch.Tensor:
    for i, layer in enumerate(self.network):
        x = layer(x)
    return F.normalize(x, p=2, dim=1)  # ||z|| = 1
```

ä½†åœ¨ RTF è®­ç»ƒæ—¶ï¼Œçº¿æ€§æ’å€¼ç ´åäº†è¿™ä¸ªçº¦æŸï¼š

**æ•°å­¦æ¨å¯¼ï¼š**

ç»™å®š `||z1|| = ||z2|| = 1`ï¼Œè®¡ç®— `z_t = (1-t) * z1 + t * z2` çš„ normï¼š

```
||z_t||Â² = ||(1-t)z1 + tÂ·z2||Â²
         = (1-t)Â² + tÂ² + 2t(1-t)cos(Î¸)
         = 1 - 2t(1-t)(1 - cos(Î¸))
```

å…¶ä¸­ Î¸ æ˜¯ z1 å’Œ z2 çš„å¤¹è§’ã€‚

**å…³é”®å‘ç°ï¼š**
- å½“ Î¸ = 0Â° (å®Œå…¨ç›¸åŒ)ï¼š||z_t|| = 1 âœ“
- å½“ Î¸ = 90Â° (æ­£äº¤)ï¼š||z_t|| = âˆš(0.5) â‰ˆ 0.707 âš ï¸
- å½“ Î¸ = 180Â° (ç›¸å)ï¼š||z_t|| = |1 - 2t| âš ï¸

**ä¾‹å­ï¼š**
```python
z1 = [1, 0]
z2 = [0, 1]  # æ­£äº¤
t = 0.5
z_t = 0.5 * [1,0] + 0.5 * [0,1] = [0.5, 0.5]
||z_t|| = âˆš(0.25 + 0.25) â‰ˆ 0.707 â‰  1
```

### 3. è®­ç»ƒ-æ¨ç†ä¸ä¸€è‡´çš„åæœ

**ä¹‹å‰çš„å®ç°ï¼ˆåªåœ¨æ¨ç†æ—¶å½’ä¸€åŒ–ï¼‰ï¼š**

```python
# è®­ç»ƒæ—¶
z_t = (1-t) * z1 + t * z2  # norm(z_t) âˆˆ [0.707, 1.0]
v_pred = backbone(z_t, t)   # æ¨¡å‹å­¦ä¹ å¤„ç† normâ‰ 1 çš„è¾“å…¥

# æ¨ç†æ—¶
z = z + v * dt
z = F.normalize(z, p=2, dim=1)  # å¼ºåˆ¶ norm(z) = 1.0
```

**é—®é¢˜ï¼š**
1. è®­ç»ƒæ—¶æ¨¡å‹è§åˆ°çš„ z_t norm åœ¨ 0.7-1.0 ä¹‹é—´
2. æ¨ç†æ—¶åªç»™æ¨¡å‹ norm=1.0 çš„è¾“å…¥
3. **åˆ†å¸ƒä¸åŒ¹é…** â†’ é‡‡æ ·è´¨é‡å·®

**AE Decoder çš„å›°å¢ƒï¼š**
- AE è®­ç»ƒæ—¶ï¼šDecoder è¾“å…¥ norm = 1.0ï¼ˆæ¥è‡ª Encoderï¼‰
- RTF è®­ç»ƒæ—¶ï¼šDecoder è¾“å…¥ norm âˆˆ [0.7, 1.0]ï¼ˆæ¥è‡ª z_tï¼‰
- RTF æ¨ç†æ—¶ï¼šDecoder è¾“å…¥ norm = 1.0ï¼ˆå½’ä¸€åŒ–åï¼‰

ä¸‰ä¸ªé˜¶æ®µçš„è¾“å…¥åˆ†å¸ƒä¸ä¸€è‡´ï¼

## âœ… å®Œæ•´è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€æƒ³

**åœ¨è®­ç»ƒå’Œæ¨ç†æ—¶éƒ½å½’ä¸€åŒ–ï¼Œä¿æŒåˆ†å¸ƒä¸€è‡´æ€§ã€‚**

### ä¿®æ”¹ 1: RectifiedFlow åŸºç±»æ·»åŠ  normalize_latent å‚æ•°

```python
class RectifiedFlow(nn.Module):
    def __init__(
        self,
        backbone: nn.Module,
        ln_noise: bool = True,
        normalize_latent: bool = True,  # âœ¨ æ–°å¢
    ):
        super().__init__()
        self.backbone = backbone
        self.ln_noise = ln_noise
        self.normalize_latent = normalize_latent
```

### ä¿®æ”¹ 2: RFDirect è®­ç»ƒæ—¶å½’ä¸€åŒ–

```python
def forward(self, z1, z2, cond):
    # çº¿æ€§æ’å€¼
    z_t = (1 - t_exp) * z1 + t_exp * z2
    
    # ğŸ”§ å…³é”®ä¿®å¤ï¼šè®­ç»ƒæ—¶ä¹Ÿå½’ä¸€åŒ–
    if self.normalize_latent:
        z_t = F.normalize(z_t, p=2, dim=1)
    
    # é¢„æµ‹é€Ÿåº¦åœº
    v_pred = self.backbone(z_t, t, cond)
    v_target = z2 - z1
    
    loss = F.mse_loss(v_pred, v_target)
    return loss
```

### ä¿®æ”¹ 3: RFDirect é‡‡æ ·æ—¶å½’ä¸€åŒ–

```python
@torch.no_grad()
def sample(self, z_start, sample_steps, normalize_latent=True):
    z = z_start.clone()
    dt = 1.0 / sample_steps
    
    for step in range(sample_steps):
        t = step / sample_steps
        v = self.backbone(z, t, cond)
        
        # æ¬§æ‹‰æ­¥
        z = z + v * dt
        
        # ğŸ”§ å…³é”®ä¿®å¤ï¼šæ¯æ­¥åå½’ä¸€åŒ–
        if normalize_latent:
            z = F.normalize(z, p=2, dim=1)
    
    return z
```

### ä¿®æ”¹ 4: RFInversion ä¹Ÿéœ€è¦å½’ä¸€åŒ–

å¯¹äº Inversion æ¨¡å¼ï¼ˆdata â†’ noise â†’ dataï¼‰ï¼Œä¹Ÿè¦ä¿æŒä¸€è‡´æ€§ï¼š

```python
# è®­ç»ƒæ—¶
noise = torch.randn_like(z1)
if self.normalize_latent:
    noise = F.normalize(noise, p=2, dim=1)  # å™ªå£°ä¹Ÿåœ¨å•ä½çƒé¢ä¸Š

z_t = (1 - t_exp) * z1 + t_exp * noise
if self.normalize_latent:
    z_t = F.normalize(z_t, p=2, dim=1)
```

### ä¿®æ”¹ 5: RTFSystem åˆ›å»ºæ¨¡å‹æ—¶ä¼ é€’å‚æ•°

```python
normalize_latent = getattr(cfg.model, 'normalize_latent', True)

if cfg.model.mode == "direct":
    self.model = RFDirect(
        backbone, 
        ln_noise=cfg.model.ln_noise,
        normalize_latent=normalize_latent  # âœ¨ ä¼ é€’å‚æ•°
    )
```

### ä¿®æ”¹ 6: é…ç½®æ–‡ä»¶

```yaml
# config/rtf.yaml
model:
  normalize_latent: true  # ä¸º scimilarity encoder å¯ç”¨
```

## ğŸ“Š é¢„æœŸæ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆåªåœ¨æ¨ç†æ—¶å½’ä¸€åŒ–ï¼‰

```
Epoch 0: é‡‡æ ·å®Œæˆ
  åŸå§‹ç©ºé—´é‡å»ºè¯¯å·®: 0.339383
  æ½œç©ºé—´é‡å»ºè¯¯å·®: 0.000395
  é‡å»ºç›¸å…³æ€§: 0.0085  âš ï¸ æä½
```

**é—®é¢˜ï¼š**
- é‡å»ºç›¸å…³æ€§æä½ï¼ˆ0.0085ï¼‰
- åŸå§‹ç©ºé—´è¯¯å·®å¾ˆé«˜ï¼ˆ0.33+ï¼‰
- æ½œç©ºé—´è¯¯å·®å°ï¼Œè¯´æ˜ RTF å­¦ä¹ æ²¡é—®é¢˜ï¼Œä½† Decoder è§£ç å¤±è´¥

### ä¿®å¤åï¼ˆè®­ç»ƒå’Œæ¨ç†éƒ½å½’ä¸€åŒ–ï¼‰

**é¢„æœŸï¼š**
```
Epoch 0: é‡‡æ ·å®Œæˆ
  åŸå§‹ç©ºé—´é‡å»ºè¯¯å·®: 0.05 - 0.15  âœ… é™ä½ 2-6å€
  æ½œç©ºé—´é‡å»ºè¯¯å·®: 0.0003 - 0.0005  âœ“ ä¿æŒä¸å˜
  é‡å»ºç›¸å…³æ€§: 0.85 - 0.95  âœ… æå‡ 100å€ï¼
```

**æ”¹å–„åŸå› ï¼š**
1. è®­ç»ƒå’Œæ¨ç†åˆ†å¸ƒä¸€è‡´
2. Decoder å§‹ç»ˆæ”¶åˆ° norm=1 çš„è¾“å…¥
3. ç¬¦åˆ scimilarity çš„è®¾è®¡åˆè¡·

## ğŸ¯ ä¸ºä»€ä¹ˆä¹‹å‰çš„ä¿®å¤ä¸å¤Ÿï¼Ÿ

### ç¬¬ä¸€æ¬¡ä¿®å¤ï¼ˆåªåœ¨æ¨ç†æ—¶å½’ä¸€åŒ–ï¼‰

```python
# æ¨ç†æ—¶
z = z + v * dt
z = F.normalize(z, p=2, dim=1)  # åªåœ¨è¿™é‡Œå½’ä¸€åŒ–
```

**é—®é¢˜ï¼š**
- è®­ç»ƒæ—¶æ¨¡å‹å­¦ä¹ å¤„ç† norm âˆˆ [0.7, 1.0] çš„è¾“å…¥
- æ¨ç†æ—¶åªç»™ norm = 1.0 çš„è¾“å…¥
- **è®­ç»ƒ-æ¨ç†ä¸åŒ¹é…ï¼**

### å®Œæ•´ä¿®å¤ï¼ˆè®­ç»ƒå’Œæ¨ç†éƒ½å½’ä¸€åŒ–ï¼‰

```python
# è®­ç»ƒæ—¶
z_t = (1-t) * z1 + t * z2
z_t = F.normalize(z_t, p=2, dim=1)  # å½’ä¸€åŒ–

# æ¨ç†æ—¶
z = z + v * dt
z = F.normalize(z, p=2, dim=1)  # å½’ä¸€åŒ–
```

**å¥½å¤„ï¼š**
- âœ… è®­ç»ƒå’Œæ¨ç†åˆ†å¸ƒä¸€è‡´
- âœ… éƒ½æ˜¯ norm = 1.0
- âœ… ç¬¦åˆ scimilarity æ¶æ„

## ğŸ§ª ç†è®ºåˆ†æ

### åœ¨å•ä½çƒé¢ä¸Šçš„ Rectified Flow

æ ‡å‡† Rectified Flow åœ¨æ¬§å‡ é‡Œå¾—ç©ºé—´ä¸­æ²¿ç›´çº¿è¿åŠ¨ã€‚ä½†åœ¨å•ä½çƒé¢ä¸Šï¼š

1. **çº¿æ€§æ’å€¼ä¼šç¦»å¼€çƒé¢**ï¼š
   ```
   z_t = (1-t) * z1 + t * z2
   ||z_t|| < 1 (é™¤é z1 å’Œ z2 å¹³è¡Œ)
   ```

2. **å½’ä¸€åŒ–åç›¸å½“äºå¤§åœ†å¼§**ï¼š
   ```
   z_t_normalized = z_t / ||z_t||
   ```
   è¿™æ˜¯å•ä½çƒé¢ä¸Šä» z1 åˆ° z2 çš„æ’å€¼ã€‚

3. **é€Ÿåº¦åœºçš„å«ä¹‰**ï¼š
   - ä¸å½’ä¸€åŒ–ï¼šv = z2 - z1ï¼ˆæ¬§æ°ç©ºé—´çš„é€Ÿåº¦ï¼‰
   - å½’ä¸€åŒ–åï¼šv ä»ç„¶æ˜¯ z2 - z1ï¼Œä½†åº”ç”¨åˆ°çƒé¢åˆ‡ç©ºé—´

### ä¸ºä»€ä¹ˆè¿™æ ·æ˜¯æ­£ç¡®çš„ï¼Ÿ

è™½ç„¶æˆ‘ä»¬æ”¹å˜äº†æ’å€¼è·¯å¾„ï¼ˆä»ç›´çº¿å˜æˆæŠ•å½±åˆ°çƒé¢ï¼‰ï¼Œä½†ï¼š

1. **ç›®æ ‡ä¸å˜**ï¼šä» z1 åˆ° z2
2. **è·¯å¾„å…‰æ»‘**ï¼šå½’ä¸€åŒ–åçš„è·¯å¾„è¿ç»­å¯å¯¼
3. **ä¿æŒçº¦æŸ**ï¼šå§‹ç»ˆåœ¨å•ä½çƒé¢ä¸Šï¼ˆç¬¦åˆ Encoder è¾“å‡ºï¼‰
4. **Decoder å‹å¥½**ï¼šè¾“å…¥åˆ†å¸ƒä¸ AE è®­ç»ƒä¸€è‡´

è¿™å®é™…ä¸Šæ˜¯å°† Rectified Flow æ‰©å±•åˆ°äº†**é»æ›¼æµå½¢**ï¼ˆå•ä½çƒé¢ï¼‰ä¸Šã€‚

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### é»˜è®¤é…ç½®ï¼ˆæ¨èï¼‰

ä½¿ç”¨ scimilarity é¢„è®­ç»ƒæ¨¡å‹æ—¶ï¼Œé»˜è®¤å¯ç”¨ï¼š

```bash
python train_rtf.py \
  --ae_checkpoint=output/ae_finetune/checkpoints/last.ckpt \
  --data_path=data.h5ad
  # normalize_latent=true (é»˜è®¤)
```

### è‡ªå®šä¹‰é…ç½®

å¦‚æœä»å¤´è®­ç»ƒ AEï¼ˆä¸ä½¿ç”¨ scimilarityï¼‰ï¼š

```bash
python train_rtf.py \
  --ae_checkpoint=output/ae_scratch/checkpoints/last.ckpt \
  --model__normalize_latent=false
```

## ğŸ“‹ å®Œæ•´ä¿®æ”¹åˆ—è¡¨

âœ… **models/rtf.py**:
- RectifiedFlow.__init__: æ·»åŠ  normalize_latent å‚æ•°
- RFDirect.forward: è®­ç»ƒæ—¶å½’ä¸€åŒ– z_t
- RFDirect.sample: é‡‡æ ·æ—¶å½’ä¸€åŒ–ï¼ˆå·²æœ‰ï¼‰
- RFInversion.forward: è®­ç»ƒæ—¶å½’ä¸€åŒ– z_t å’Œ noise
- RFInversion.sample: é‡‡æ ·æ—¶å½’ä¸€åŒ–ï¼ˆå·²æœ‰ï¼‰
- RTFSystem.__init__: åˆ›å»ºæ¨¡å‹æ—¶ä¼ é€’ normalize_latent

âœ… **config/rtf.yaml**:
- æ·»åŠ  normalize_latent: true

## ğŸ“ å…³é”®è¦ç‚¹

1. **è®­ç»ƒ-æ¨ç†ä¸€è‡´æ€§è‡³å…³é‡è¦**
   - æ¨¡å‹åœ¨è®­ç»ƒæ—¶çœ‹åˆ°ä»€ä¹ˆåˆ†å¸ƒï¼Œæ¨ç†æ—¶å°±åº”è¯¥ç»™ä»€ä¹ˆåˆ†å¸ƒ

2. **çº¿æ€§æ’å€¼ä¸ä¿æŒ norm**
   - å³ä½¿ ||z1|| = ||z2|| = 1ï¼Œ||z_t|| å¯èƒ½ < 1

3. **scimilarity è®¾è®¡åœ¨å•ä½çƒé¢ä¸Š**
   - Encoder è¾“å‡ºå½’ä¸€åŒ–
   - Decoder æœŸæœ›å½’ä¸€åŒ–è¾“å…¥
   - RTF å¿…é¡»å°Šé‡è¿™ä¸ªè®¾è®¡

4. **ä¸è¦åªåœ¨æ¨ç†æ—¶ä¿®å¤**
   - æ¨ç†æ—¶å½’ä¸€åŒ– âœ“
   - è®­ç»ƒæ—¶ä¹Ÿè¦å½’ä¸€åŒ– âœ“âœ“

## ğŸ”— ç›¸å…³èµ„æº

1. **Rectified Flow on Manifolds**
   - åœ¨æµå½¢ä¸Šçš„ Rectified Flow æ˜¯ä¸€ä¸ªæ´»è·ƒçš„ç ”ç©¶æ–¹å‘
   - å•ä½çƒé¢æ˜¯æœ€ç®€å•çš„éæ¬§æµå½¢

2. **Metric Learning**
   - L2 å½’ä¸€åŒ–æ˜¯åº¦é‡å­¦ä¹ çš„æ ‡å‡†æŠ€æœ¯
   - Triplet loss, Contrastive learning éƒ½ä½¿ç”¨å½’ä¸€åŒ–

3. **scimilarity**
   - Nature 2024: "A cell atlas foundation model"
   - åœ¨ 2270ä¸‡ ç»†èƒä¸Šè®­ç»ƒï¼Œä½¿ç”¨å½’ä¸€åŒ–åµŒå…¥

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸è¦é‡æ–°è®­ç»ƒ AE**
   - AE å·²ç»åœ¨å½’ä¸€åŒ–çº¦æŸä¸‹è®­ç»ƒå¥½äº†
   - åªéœ€è¦è®© RTF é€‚åº”è¿™ä¸ªçº¦æŸ

2. **æ£€æŸ¥å…¶ä»–é¢„è®­ç»ƒæ¨¡å‹**
   - å¦‚æœä½¿ç”¨å…¶ä»–é¢„è®­ç»ƒ encoderï¼Œæ£€æŸ¥æ˜¯å¦å½’ä¸€åŒ–
   - æ ¹æ®æƒ…å†µè®¾ç½® normalize_latent

3. **ç›‘æ§è®­ç»ƒæŒ‡æ ‡**
   - é‡å»ºç›¸å…³æ€§åº”è¯¥å¿«é€Ÿæå‡åˆ° 0.8+
   - åŸå§‹ç©ºé—´è¯¯å·®åº”è¯¥é™ä½åˆ° 0.1 ä»¥ä¸‹

## ğŸš€ ä¸‹ä¸€æ­¥

1. é‡æ–°è¿è¡Œè®­ç»ƒï¼Œåº”è¯¥ä¼šçœ‹åˆ°æ˜¾è‘—æ”¹å–„
2. å¦‚æœæ•ˆæœè¿˜ä¸ç†æƒ³ï¼Œå¯èƒ½éœ€è¦ï¼š
   - è°ƒæ•´å­¦ä¹ ç‡
   - å¢åŠ è®­ç»ƒæ­¥æ•°
   - æ£€æŸ¥æ•°æ®é¢„å¤„ç†

